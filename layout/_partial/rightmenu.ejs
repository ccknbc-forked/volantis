<% if (theme.rightmenu && theme.rightmenu.enable == true && theme.rightmenu.layout.length > 0) { %>
  <% function loadmenu(obj) { %>
    <li>
      <a class='vlts-menu fix-cursor-default' <%= obj.url ? 'href='+ url_for(obj.url)+'' : ''%>
        <% if (obj.rel) { %>
          rel="<%- obj.rel %>"
        <% } %>
        <% if (obj.target) { %>
          target="<%- obj.target %>"
        <% } %>
        <% if (obj.onclick) { %>
          onclick="<%- obj.onclick %>"
        <% } %>
        <% if (obj.id) { %>
          id="<%- obj.id %>"
        <% } else if (obj.url) { %>
          id="<%= url_for(obj.url).replace(/\/|%|\./g, "")?url_for(obj.url).replace(/\/|%|\./g, ""):"home" %>"
        <% } %>>
        <% if (obj.icon) { %><i class='<%= obj.icon %> fa-fw'></i><% } %> <%- obj.name %>
      </a>
    </li>
  <% } %>

  <div id="rightmenu-wrapper">
    <ul class="list-v rightmenu" id="rightmenu-content">
      <% theme.rightmenu.layout.forEach(function(item){ %>
        <% if (item == 'hr') { %>
          <hr>
        <% } else if (item == 'navigation') { %>
          <li class='navigation'>
            <a class='nav icon-only' onclick='history.back()'><i class='fa fa-arrow-left fa-fw'></i></a>
            <a class='nav icon-only' onclick='history.forward()'><i class='fa fa-arrow-right fa-fw'></i></a>
            <a class='nav icon-only' onclick='window.location.reload()'><i class='fa fa-redo fa-fw'></i></a>
            <a class='nav icon-only fix-cursor-default' href='/'><i class='fa fa-home fa-fw'></i></a>
          </li>
        <% } else if (item == 'music' && theme.plugins.aplayer.enable == true) { %>
          <li class='music name'>
            <p class='nav music-title'></p>
          </li>
          <li class='music ctrl'>
            <a class='nav icon-only backward' onclick='aplayerBackward()'><i class='fa fa-step-backward fa-fw'></i></a>
            <a class='nav icon-only toggle' onclick='aplayerToggle()'><i class='fa fa-play fa-fw'></i></a>
            <a class='nav icon-only forward' onclick='aplayerForward()'><i class='fa fa-step-forward fa-fw'></i></a>
          </li>
          <li class='music volume'>
            <a class='nav volume'>
              <div class="aplayer-volume-bar-wrap">
                <div class="aplayer-volume-bar fix-cursor-pointer">
                  <div class="aplayer-volume"></div>
                  <i class='left fal fa-volume-off fa-fw'></i>
                  <i class='right fal fa-volume-up fa-fw'></i>
                </div>
              </div>
            </a>
          </li>
        <% } else if (item in theme.rightmenu) { %>
          <% loadmenu(theme.rightmenu[item]) %>
        <% } %>
      <% }) %>
    </ul>
  </div>

  <script>
    window.document.oncontextmenu = function () {
      if (event.ctrlKey) return true;
      if($(window).width() <= 500) return true;

      var copy = document.getElementById('menu-copy');
      var select = window.getSelection().toString(); // 鼠标选中的文本
      copy.style.display = select == "" ? "none" : "block";

      var mymenu = document.getElementById('rightmenu-wrapper');
      var menuContent = document.getElementById('rightmenu-content');
      var mouseClientX = event.clientX;
      var mouseClientY = event.clientY;
      var menuWidth = menuContent.offsetWidth == 0 ? 160 : menuContent.offsetWidth;
      var menuHeight = menuContent.offsetHeight == 0 ? 340 : menuContent.offsetHeight;
      var screenWidth = document.documentElement.clientWidth || document.body.clientWidth;
      var screenHeight = document.documentElement.clientHeight || document.body.clientHeight;
      mymenu.style.left = event.clientX + "px"; // 获取鼠标位置
      mymenu.style.top = event.clientY + "px";
      mymenu.style.display = 'block';
      if (event.clientX * 2 > screenWidth) {
        menuContent.classList.add('left');
      } else {
        menuContent.classList.remove('left');
      }
      if (event.clientY * 2 > screenHeight) {
        menuContent.classList.add('top');
      } else {
        menuContent.classList.remove('top');
      }

      // 选中文本
      if (window.getSelection().toString()) {
        document.getElementById('menu-copy').style.display = 'block';
      } else {
        document.getElementById('menu-copy').style.display = 'none';
      }

      // 选中图片
      if (event.toElement.currentSrc) {
        document.getElementById('menu-copy-img').style.display = 'block';
        document.getElementById('menu-copy-img').addEventListener("click", function (e) {
          copyString(event.toElement.currentSrc);
        });
      } else {
        document.getElementById('menu-copy-img').style.display = 'none';
      }

      // 有音乐播放器
      if (<%= theme.plugins.aplayer.enable %> == true) {
        // 如果有aplayer，初始化一下
      	try {
      		checkAPlayer();
          updateTitle();
      	} catch (error) {
      		console.log(error);
      	}
      }
      return false;
    };

    document.addEventListener("click", function (event) {
      hideMenu();
    });

    function hideMenu() {
      document.getElementById('rightmenu-wrapper').style.display = 'none';
    }
    function menuCopy() {
      document.execCommand("Copy");
      $.message({title:'复制成功',message: window.getSelection().toString(),type:'success'});
    }
    function menuPlay() {
      var canplay = getCookie('canplay');
      if( canplay == null || canplay == 'true') {
        document.querySelector('meting-js').aplayer.play();
      } else {
        $.message({title: "音乐通知",message: "音乐加载失败，建议刷新~",type:'warning'});
      }
    }
    function menuPause() {
      var canplay = getCookie('canplay');
      if( canplay == null || canplay == 'true') {
        document.querySelector('meting-js').aplayer.pause();
        var index = document.querySelector('meting-js').aplayer.list.index;
        var title = document.querySelector('meting-js').aplayer.list.audios[index].title;
        var artist = document.querySelector('meting-js').aplayer.list.audios[index].artist;
        $.message({title:'音乐通知',message: '暂停播放：' + title + ' - ' + artist, type:'success'});
      } else {
        $.message({title: "音乐通知",message: "音乐加载失败，建议刷新~",type:'warning'});
      }
    }
    function menuBackward() {
      var canplay = getCookie('canplay');
      if( canplay == null || canplay == 'true') {
        document.querySelector('meting-js').aplayer.skipBack();
        document.querySelector('meting-js').aplayer.play();
      } else {
        $.message({title: "音乐通知",message: "音乐加载失败，建议刷新~",type:'warning'});
      }
    }
    function menuForward() {
      var canplay = getCookie('canplay');
      if( canplay == null || canplay == 'true') {
        document.querySelector('meting-js').aplayer.skipForward();
        document.querySelector('meting-js').aplayer.play();
      } else {
        $.message({title: "音乐通知",message: "音乐加载失败，建议刷新~",type:'warning'});
      }
    }
  </script>
<% } %>
